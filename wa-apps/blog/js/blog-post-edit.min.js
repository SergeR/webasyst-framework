(function(a){a.wa_blog.editor={options:{blogs:{},content_id:"post_text",current_blog_id:null,dateMonthCount:2,dateShowWeek:!1,cut_link_label_default:"",version:"1.0"},transliterated:!1,blog_statuses:{"private":"private","public":"public"},init:function(b){function d(b){a(this).show();a(this).parent().find(".datetime").hide();b&&a("#current-time").text(b);a("#current-time").show()}function c(a){var b=a.siblings(".hint:first");0>=b.length&&(b=a.parent().siblings(".hint:first"));return b}function e(a){a.parent().find("input[type=text]").removeClass("error");
c(a).removeClass("errormsg")}function i(a){a.parent().find("input[type=text]").addClass("error");c(a).addClass("errormsg")}function g(){return a.datepicker._defaults.dateFormat.toUpperCase().replace("YY","YYYY")}var f=this;f.options=a.extend(f.options,b);var j=function(b){if(b){var c=b.link+b.slug+"/";a("#url-link").text(c);a("#url-link").attr("href",b.preview_hash?c+"?preview="+b.preview_hash:c);a("#pure-url").text(b.link);b.slug&&!h?(a("#post-url").val(b.slug),h=b.slug):a("#post-url").val(h);var d=
b.is_adding?"small":b.is_published?"small":"hint",e=a("#post-url-field span:first").contents().filter(function(){return this.nodeType==3}).get(0).nodeValue;if(b.other_links&&b.other_links instanceof Array){c=[];for(k in b.other_links)c.push({previewText:e,className:d,slug:h,link:b.other_links[k],href:b.preview_hash?b.other_links[k]+h+"/?preview="+b.preview_hash:b.other_links[k]+h+"/"});b=b.is_adding?'<span class="${className}">${previewText}${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></span><br>':
'<span class="${className}">${previewText}<a target="_blank" href="${href}">${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></a></span><br>';d=a("#post-url-field").children(":first");d.is(".icon10")&&(b='<i class="'+d.attr("class")+'"></i> '+b);a("#other-urls").html(a.tmpl(b,c))}}a("#post-url-field").show("fast")},n=function(){a("#post-url-field").hide("fast");a("#post-url").val("")},t=function(b,c){b&&(h=b);a(".slug").each(function(){if(h){var b=a(this).text(h+"/").parents("a:first");
b.attr("href",b.text()+(c?"?preview="+c:""))}else a(this).text("")})},b=function(){a("#url-editable").hide();a("#url-edit").show();a("#post-url").focus()},o,h=null,p={},m=function(){};!a("#post-url-field").length||a("#post-url-field").hasClass("no-settlements")?m=function(b){b==a.wa_blog.editor.blog_statuses["public"]?j():n()}:(o=function(){var b=a("input[name=post_id]").val();if(!b&&!this.value)n();else{var c=a("input[name=blog_id]").val(),d=this.value,e=null,f={post_title:d,post_id:b,blog_id:c},
g=[c,b,d].join("&");p[g]?(b=p[g])&&!b.is_private_blog?j(b):n():(null!=h&&(f.slug=h),a.ajax({url:"?module=post&action=getPostUrl",data:f,dataType:"json",type:"post",async:!1,success:function(b){e=b.data;p[g]=e;a.wa_blog.editor.transliterated=!0;e&&!e.is_private_blog?j(e):n()}}))}},a("#post-form").find("input[name=post_id]").val()||a("#post-title").blur(function(){var a=this;setTimeout(function(){null==h&&o.call(a)},200)}),m=function(){o.call(a("#post-title").get(0))},a("#url-edit-link").click(b),a("#post-url").keyup(function(a){9!=
a.keyCode&&this.value!=h&&t(this.value)}));f.postUrlWidget={setEditReady:b,resetEditReady:function(){a("#url-editable").show();a("#url-edit").hide()},updateSlugs:t,changeBlog:m};var b={beforeSave:function(){var b=a(".datepicker:not(:disabled)"),c=true;if(b.length>0){var d=b.parent(".datetime").find(".time");if(d.length>0){var e;if(e=d.get(0)){e=d.eq(0).val();e=!(e>=0&&e<=24)}e&&(c=false);if(e=d.get(1)){d=d.eq(1).val();e=!(d>=0&&d<=60)}e&&(c=false)}c||i(b)}if(!c)return false;a.wa_blog.editor.onSubmit()},
afterSave:function(b){a("#b-post-save-button").removeClass("yellow").addClass("green");a("#postpublish-edit").removeClass("yellow").addClass("green");f.postUrlWidget.resetEditReady();f.postUrlWidget.updateSlugs(b.url,b.preview_hash||false);d.call(a("#inline-edit-datetime").get(0),b.formatted_datetime);f.inlineSaveController.getAction()=="draft"&&a("#post-url-field .small").removeClass("small").addClass("hint");b=a("#b-post-edit-custom-params-dialog");if(!b.is(":hidden")){var c=b.find(":input[name=meta_title]").val(),
e=b.find(":input[name=meta_keywords]").val(),j=b.find(":input[name=meta_description]").val(),g=b.find(":input[name=params]").val();c?a("#b-post-edit-meta-title").show().find(".val").text(c):a("#b-post-edit-meta-title").hide();e?a("#b-post-edit-meta-keywords").show().find(".val").text(e):a("#b-post-edit-meta-keywords").hide();j?a("#b-post-edit-meta-description").show().find(".val").text(j):a("#b-post-edit-meta-description").hide();g?a("#b-post-edit-custom-params").show().html(g.trim().split("\n").join("<br>")+
"<br>"):a("#b-post-edit-custom-params").hide();c||e||j||g?a("#b-post-edit-no-meta").hide():a("#b-post-edit-no-meta").show();b.trigger("close")}}},u=function(){if(w()!==false){var b=x,c=a.wa_blog.editor.wysiwygToHtml(a("#post_text","#post-form").val());a("#post_text","#post-form").val(c);c=a("#post-form").serialize()+"&"+l+"=1";c=c+(q?"&inline=1":"");c=c+(!a.wa_blog.editor.transliterated?"&transliterate=1":"");b=b||function(){};r("loading");a.ajax({url:"?module=post&action=save",data:c,dataType:"json",
type:"post",success:function(c){if(c.status=="fail"){c.errors.datetime||a.wa_blog.editor.closeCurrentDialog();var d=c.errors;if(d.url){a("#post-url-field").show();var e=a("#post-url"),j=d.url,f="#message-"+e.attr("id");e.addClass("error");a(f).addClass("errormsg").text(j)}if(d.datetime){d=a(".datepicker:not(:disabled)");d.length&&i(d)}if(!c.errors.datetime&&l=="deadline"){(c=a("#deadline-dialog .datepicker").val())?a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted",
{date:c})):a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted"));a("#b-post-save-draft-button").attr("name","deadline")}}else if(c.data.redirect)location.href=c.data.redirect;else{b(c.data);c.data.id&&a("#post-id").val(c.data.id);r("saved")}q=false;r("")},error:function(){}})}},r=function(b,c){if(b){a("#form-status span").hide();a("#form-status #"+b+"-status").show();a("#form-status").show()}else a("#form-status").fadeOut(c&&typeof c=="function"?c:function(){})},b=
b||{},l="",q=!1,w=b.beforeSave||function(){},x=b.afterSave||function(){};a("input[type=submit], input[type=button], a.js-submit").click(function(){if(a(this).hasClass("dialog-edit"))return false;if(a(this).hasClass("js-submit")){var b=a(this).attr("title")||a(this).text()||"Are you sure?";if(!confirm(b))return false}if(a("#post-id").val()&&(this.id=="b-post-save-button"||this.id=="b-post-save-draft-button"||this.id=="b-post-save-custom-params"))q=true;l=this.name;(l=="deadline"||l=="schedule")&&a("#"+
this.name+"-dialog").find("input[name^=datetime]").attr("disabled",false);u();return false});a("#post-url").focus(function(){});f.inlineSaveController={save:u,setAction:function(a){l=a},getAction:function(){return l}};b=function(){var b="#"+this.id+"-on-label",c="#"+this.id+"-off-label";if(this.checked){a(b).removeClass("b-unselected");a(c).addClass("b-unselected")}else{a(b).addClass("b-unselected");a(c).removeClass("b-unselected")}};m=a("#allow-comment-switcher");b.call(m.get(0));m.iButton({labelOn:"",
labelOff:"",className:"mini"}).change(b);b=f.options;b={changeMonth:!0,changeYear:!0,shortYearCutoff:2,showOtherMonths:2>b.dateMonthCount,selectOtherMonths:2>b.dateMonthCount,stepMonths:b.dateMonthCount,numberOfMonths:b.dateMonthCount,showWeek:b.dateShowWeek,gotoCurrent:!0,constrainInput:!1,beforeShow:function(){setTimeout(function(){a("#ui-datepicker-div").css("z-index")<10&&a("#ui-datepicker-div").css("z-index",10)},0)}};a(".datepicker").datepicker(b).filter("input[name^=schedule_datetime]").datepicker("option",
"minDate",new Date);a("#ui-datepicker-div").hide();a(".datepicker").focus(function(){e(a(this))});var y=function(){var b=a(this).attr("id").replace(/-.*$/,"");a.wa_blog.editor.currentDialog=a("#"+b+"-dialog").waDialog({disableButtonsOnSubmit:true,onLoad:function(){a(this).find("input,select").removeAttr("disabled");a(".user-date-format").text(g())},onSubmit:function(){return false},onCancel:function(){a(this).find("input:text,select").each(function(){a(this).value=a(this).defaultValue;a(this).attr("disabled",
"disabled")})}});return false};a(".dialog-edit").each(function(){a(this).click(function(a){a.preventDefault();return y.call(a.target)})});b=null;try{b=a.storage.get("blog/editor")||"redactor"}catch(s){this.log("Exception: "+s.message+"\nline: "+s.fileName+":"+s.lineNumber)}if(!b||!this.editors[b])for(b in this.editors)break;if(!this.selectEditor(b,!0))for(b in this.editors)if(this.selectEditor(b,!0))break;a("#post-form").find("input[name=post_id]").val()||a("#post-title").focus();a.wa.dropdownsCloseEnable();
a(".change-blog").click(a.wa_blog.editor.changeBlogHandler);a('#postpublish-dialog input[name="publish_blog_id"]').change(a.wa_blog.editor.changePublishBlogHandler);a("#post-title").keyup(function(){var b=a(this),c=b.next(".maxlength"),d=parseInt(b.attr("maxlength"));d&&b.val().length>=d&&!c.length?b.after('<em class="hint maxlength">'+$_("input_maxlength").replace(/%d/,d)+"</em>"):(!d||b.val().length<d)&&c.length&&c.remove()});a("#inline-edit-datetime").click(function(){a(this).hide();a(this).parent().find(".datetime").show();
a("#current-time").hide();a(".user-date-format").text(g())});a(".b-post-editor-toggle li a").click(this.editorTooggle);a(document).keydown(function(a){if(a.ctrlKey&&a.keyCode==83)f.onSaveHotkey(a)});a(".time").focus(function(){e(a(this).parent().find(".datepicker"))});a("#post-form").submit(function(){return false});a("#b-post-edit-custom-params-link").click(function(){a("#b-post-edit-custom-params-dialog").waDialog({onSubmit:function(){return false}});return false});var v=a(window);a("#buttons-bar").sticky&&
a("#buttons-bar").sticky({fixed_class:"b-fixed-button-bar",isStaticVisible:function(a){return v.scrollTop()+v.height()>=a.element.offset().top+a.element.outerHeight()}})},cloneTextarea:function(b,d,c){var e="editor_container_"+c;a(d).append(b.clone(!0).attr({id:e,name:"text_"+c,disabled:!0}));b.hide();return e},cut_hr:'<span class="b-elrte-wa-split-vertical elrte-wa_post_cut">%text%</span>',cut_str:"<\!-- more %text%--\>",htmlToWysiwyg:function(b){return b.replace(/<\!--[\s]*?more[\s]*?(text[\s]*?=[\s]*?['"]([\s\S]*?)['"])*[\s]*?--\>/g,
function(b,c,e){return e?a.wa_blog.editor.cut_hr.replace("%text%",e):a.wa_blog.editor.cut_hr.replace("%text%",a.wa_blog.editor.options.cut_link_label_default)})},wysiwygToHtml:function(b){var d=a("<p></p>").html(b),c=d.find(".elrte-wa_post_cut");return c.length?(b=c.html(),!b||"<br>"===b||b===a.wa_blog.editor.options.cut_link_label_default?c.replaceWith(a.wa_blog.editor.cut_str.replace("%text%","")):c.replaceWith(a.wa_blog.editor.cut_str.replace("%text%",'text="'+b+'" ')),d.html().replace("<span></span>",
"")):b},editors:{ace:{editor:null,container:null,inited:!1,init:function(b){if(!this.inited){this.inited=!0;this.container=a('<div id="blog-ace-editor"></div>').appendTo("#post_text_wrapper");this.container.wrap('<div class="ace"></div>');this.editor=ace.edit("blog-ace-editor");ace.config.set("basePath",wa_url+"wa-content/js/ace/");this.editor.setTheme("ace/theme/eclipse");var d=this.editor.getSession();d.setMode("ace/mode/javascript");d.setMode("ace/mode/css");d.setMode("ace/mode/html");d.setMode("ace/mode/smarty");
d.setUseWrapMode(!0);this.editor.renderer.setShowGutter(!1);this.editor.setShowPrintMargin(!1);this.editor.setFontSize(13);a(".ace_editor").css("fontFamily","");d.setValue(b.hide().val());this.editor.moveCursorTo(0,0);-1!=navigator.appVersion.indexOf("Mac")?this.editor.setFontSize(13):-1!=navigator.appVersion.indexOf("Linux")?this.editor.setFontSize(16):this.editor.setFontSize(14);this.editor.commands.addCommand({name:"unfind",bindKey:{win:"Ctrl-F",mac:"Command-F"},exec:function(){return!1},readOnly:!0});
var c=function(b,c){var d=b.getSession().getScreenLength()*b.renderer.lineHeight+b.renderer.scrollBar.getWidth(),d=1.02*d,e=a("#post-form .sidebar:first .b-edit-options").height()-163;d<e&&(d=e);a("#"+c).height(d.toString()+"px");b.resize()},e=this,i=a(window);d.on("change",function(){c(e.editor,"blog-ace-editor");i.scroll()});setTimeout(function(){c(e.editor,"blog-ace-editor")},50);i.resize(function(){e.editor.resize();c(e.editor,"blog-ace-editor")});this.container.on("keydown",a.wa_blog.editor.editorKeyCallback());
this.container.on("keypress",a.wa_blog.editor.editorKeyCallback(!0))}return!0},show:function(b){this.container.show();this.container.parent().show();var d=this;setTimeout(function(){if(d.editor){var c=a.wa_blog.editor.wysiwygToHtml(b.val()),e=d.editor.getCursorPosition();d.editor.setValue(c);a("#post-title").is(":focus")||d.editor.focus();d.editor.navigateTo(e.row,e.column)}else"object"==typeof console&&console.log("wait for ace editor init"),d.show(b)},100)},hide:function(){this.container.hide();
this.container.parent().hide()},update:function(a){this.inited&&a.val(this.editor.getValue())},correctEditorHeight:function(b){return Math.max(b,a.wa_blog.editor.getMinEditorHeight())+a.wa_blog.editor.getExtHeightShift()}},redactor:{options:{},inited:!1,callback:!1,init:function(b){if(!this.inited){var d=a(window),c=a("#b-post-save-button"),e=a("#postpublish-edit"),i=a("#post-form .sidebar:first .b-edit-options").height(),g=a.extend({deniedTags:!1,minHeight:Math.max(300,i-229),buttonSource:!1,paragraphy:!0,
convertDivs:!0,toolbarFixedBox:!0,buttons:"html formatting bold italic underline deleted unorderedlist orderedlist outdent indent image video file table link alignment | horizontalrule".split(" "),plugins:"fontcolor fontsize fontfamily table video cut".split(" "),lang:wa_lang,imageUpload:"?module=pages&action=uploadimage&filelink=1&absolute=1",uploadImageFields:b.data("uploadFields"),imageUploadErrorCallback:function(a){alert(a.error)},syncBeforeCallback:function(a){return a=a.replace(/{[a-z$][^}]*}/gi,
function(a,b,c){var d=c.indexOf("<\/script",b+a.length),b=c.indexOf("<script",b+a.length);if(-1==d||-1!=b&&b<d)a=a.replace(/&gt;/g,">"),a=a.replace(/&lt;/g,"<"),a=a.replace(/&amp;/g,"&"),a=a.replace(/&quot;/g,'"');return a})},changeCallback:function(){e.is(":visible")&&e.removeClass("green").addClass("yellow");c.is(":visible")&&c.removeClass("green").addClass("yellow");d.scroll()}},g||{});b.redactor(g);b.redactor("core.getBox").css("z-index",0);b.redactor("core.getToolbar").css("z-index",1);this.inited=
!0}return!0},show:function(b){var d=a.wa_blog.editor.htmlToWysiwyg(b.val());b.val(d);a(".redactor-box").show();b.redactor("core.getEditor").find('img[src*="$wa_url"]').each(function(){var b=decodeURIComponent(a(this).attr("src"));a(this).attr("data-src",b);a(this).attr("src",b.replace(/\{\$wa_url\}/,wa_url))});b.redactor("code.set",b.val());b.redactor("observe.load");b.redactor("focus.setStart")},hide:function(){a(".redactor-box").hide()},update:function(a){this.inited&&a.val(a.redactor("code.get"))}}},
getMinEditorHeight:function(){return 200},getExtHeightShift:function(){return-70},editorTooggle:function(){var b=a(this);!b.hasClass("selected")&&a.wa_blog.editor.selectEditor(b.attr("id"))&&(a(".b-post-editor-toggle li.selected").removeClass("selected"),b.parent().addClass("selected"));return!1},selectEditor:function(b,d){if(this.editors[b]){var c=a("#"+this.options.content_id);if(c.length){try{if(this.editors[b].init(c)){var e=null;if(!d)try{a.storage.set("blog/editor",b)}catch(i){this.log("Exception: "+
i.message+"\nline: "+i.fileName+":"+i.lineNumber)}var g=a(".b-post-editor-toggle li.selected a");if(g.length&&(g.parent().removeClass("selected"),e=g.attr("id")))this.editors[e].update(c),this.editors[e].hide();a("#"+b).parent().addClass("selected");this.editors[b].show(c);setTimeout(function(){a(window).scroll()},0)}}catch(f){return this.log("Exception: "+f.message+"\nline: "+f.fileName+":"+f.lineNumber,f.stack),!1}return!0}this.log('Text container for "'+b+'" not found');return!1}this.log('Blog editor "'+
b+'" not found');return!1},editor_key:!1,editorKeyCallback:function(b){var d=this;return b?function(b){if(b.ctrlKey&&115==b.which&&!a.wa_blog.editor.editor_key)d.onSaveHotkey(b)}:function(b){a.wa_blog.editor.editor_key=!1;b.ctrlKey&&83==b.which&&(a.wa_blog.editor.editor_key=!0,d.onSaveHotkey(b));if(!b.metaKey&&(33>b.which||40<b.which)&&(27<b.which||8==b.which||13==b.which)&&(112>b.which||124<b.which)&&(!b.ctrlKey||67!=b.which))a("#b-post-save-button").removeClass("green").addClass("yellow"),a("#postpublish-edit").removeClass("green").addClass("yellow")}},
onSubmit:function(){var b=a.wa_blog,d;for(d in b)if("editor"!=d&&b[d].onSubmit&&"function"==typeof b[d].onSubmit)try{b[d].onSubmit()}catch(c){"object"==typeof console&&console.log(c)}b=a("#"+this.options.content_id);if(b.length){d=null;var e=a(".b-post-editor-toggle li.selected a");e.length&&(d=e.attr("id"))&&this.editors[d].update(b)}b=a("#b-post-save-button");"draft"==b.attr("name")||"deadline"==b.attr("name")||(b.removeClass("yellow").addClass("green"),a("#postpublish-edit").removeClass("yellow").addClass("green"))},
onSaveHotkey:function(b){b.preventDefault();var b=a("#b-post-save-draft-button"),d=a("#b-post-save-button");b.length?b.click():d.length&&d.click()},currentDialog:null,closeCurrentDialog:function(){this.currentDialog&&this.currentDialog.waDialog().trigger("close")},registerEditor:function(a,d){if(this.editors[a])return this.log('Editor "'+a+'" already registered'),!1;this.editors[a]=d;return!0},log:function(a,d){"object"==typeof console&&(console.log(a),d&&console.log(d))},changeBlogHandler:function(){var b=
parseInt(a(this).attr("href").replace(/^.*#/,""));a.wa_blog.editor.selectCurrentBlog(b)&&(a(".dialog :input:checked").attr("checked",!1),a(".dialog #b-post-publish-blog-"+b).attr("checked",!0));a.wa.dropdownsClose();return!1},changePublishBlogHandler:function(){if(a(this).attr("checked")){var b=parseInt(a(this).val());a.wa_blog.editor.selectCurrentBlog(b)}},selectCurrentBlog:function(b){var d=a.wa_blog.editor.options.blogs[b],c=a.wa_blog.editor.options.current_blog_id;if(d&&c!=b){var e=a.tmpl("selected-blog",
{blog:d});a(".current-blog").replaceWith(e);a("#blog-selector-"+c).removeClass("selected");e=a("#blog-selector-"+b).addClass("selected");c=a.wa_blog.editor.options.blogs[c];a.wa_blog.editor.options.current_blog_id=parseInt(b);b=a(".b-post");c&&b.removeClass(c.color);b.addClass(d.color);a.wa_blog.editor.postUrlWidget.changeBlog(e.attr("data-blog-status"));return!0}}}})(jQuery);
