(function(a){a.wa_blog.stream={management:!1,options:{pageless:{}},init:function(c){this.options=a.extend(this.options,c);var b=this;a("a[href=\\#manage]").click(function(a){return b.manageHandler.apply(b,[this,a])});a(".js-manage-done").click(function(a){return b.manageCompleteHandler.apply(b,[this,a])});a("input.search").keydown(function(f){if(13==f.keyCode){var f=a(this).val(),b=location.search.match(/[&\\?](text=.*?&|text=.*)/);b?(b=b[1],f?(f="&"==b.substr(-1)?"text="+encodeURIComponent(f)+"&":
"text="+encodeURIComponent(f),location.search=location.search.replace(b,f)):("&"!=b.substr(-1)&&(b="[&\\?]"+b),location.search=location.search.replace(RegExp(b),""))):f&&(location.search+=(location.search?"&":"?")+"text="+encodeURIComponent(f));return!1}});a("input.blog-post-checkbox").live("click",function(a){return b.counterHandler.apply(b,[this,a])});a("#postdelete-dialog input[type=button]").click(function(a){return b.deleteHandler.apply(b,[this,a])});a('#postmove-dialog input[type="button"]').click(function(a){return b.moveHandler.apply(b,
[this,a])});var e={scroll:function(){a.wa_blog.common.onContentUpdate()},afterLoad:c=function(){a(".b-stream .b-post-body").each(function(){var b=a(this);if(!b.data("ensureEverythingInside")){b.data("ensureEverythingInside",!0);var c=b.offset().top,e=0;b.find("*").each(function(){var d=a(this);({left:1,right:1})[d.css("float")]&&(d=d.offset().top+d.height()-c,d>e&&(b.css("min-height",d+"px"),e=d))})}})}};c();e=a.extend(!0,e,b.options.pageless);a.pageless(e)},manageHandler:function(){a("#blog-stream-primary-menu").hide();
a("#blog-stream-manage-menu").show();this.management=!0;this.onContentUpdate();return!1},manageCompleteHandler:function(){this.management=!1;a("#blog-stream-manage-menu").hide();a("#blog-stream-primary-menu").show();a(".b-post.js-managed").each(function(){a(this).removeClass("js-managed");a(this).find("h3:hidden").show();a(this).find("h3:first").hide();a(this).find(".b-post-body:hidden, .profile.image20px:hidden").fadeIn()});return!1},counterHandler:function(){a(".js-blog-selected-posts-counter").text(a("input.blog-post-checkbox:checked").length)},
moveHandler:function(c){var b=[];a("input.blog-post-checkbox:checked").each(function(){b.push(a(this).val())});var e=a("#postmove-dialog :input[name=blog_id]").val();b.length?(a(c).attr("disabled",!0).after('<i class="icon16 loading"></i>'),a.ajax({url:"?module=post&action=move",data:{id:b,blog:e},type:"post",dataType:"json",success:function(b){var c=!1;if("ok"==b.status)for(var e in b.data.moved){var d=a("#b-post-"+b.data.moved[e]);d.length&&(c=!0,d.animate({opacity:0.1,height:0},200,function(){d.remove()}))}a.wa_blog.stream.counterHandler();
c?window.location.reload():(a("#postmove-dialog .icon16.loading").remove(),a("#postmove-dialog input[type=button]:disabled").removeAttr("disabled"),a.wa_blog.dialogs.close("postmove"))},error:function(){a("#postmove-dialog .icon16.loading").remove();a("#postmove-dialog input[type=button]:disabled").removeAttr("disabled");a.wa_blog.dialogs.close("postmove")}})):a.wa_blog.dialogs.close("postmove")},deleteHandler:function(c){var b=[];a("input.blog-post-checkbox:checked").each(function(){b.push(a(this).val())});
b.length?(a(c).attr("disabled",!0).after('<i class="icon16 loading"></i>'),a.ajax({url:"?module=post&action=delete",data:{id:b},type:"post",dataType:"json",success:function(b){"ok"==b.status&&b.data.deleted?window.location.reload():(a("#postdelete-dialog .icon16.loading").remove(),a("#postdelete-dialog input[type=button]:disabled").removeAttr("disabled"),a.wa_blog.dialogs.close("postdelete"),a.wa_blog.stream.counterHandler())},error:function(){a("#postdelete-dialog .icon16.loading").remove();a("#postdelete-dialog input[type=button]:disabled").removeAttr("disabled");
a.wa_blog.dialogs.close("postdelete");a.wa_blog.stream.counterHandler()}})):a.wa_blog.dialogs.close("postdelete")},onContentUpdate:function(){if(this.management){var c=this,b=!1;a(".b-post-body:visible, .profile.image20px:visible").hide();a(".b-post").each(function(){a(this).hasClass("js-managed")||(a(this).find("h3:visible").hide(),a(this).find("h3:first").show(),b=!0,a(this).addClass("js-managed"))});b&&setTimeout(function(){a(c.options.pageless.target).trigger("scroll.pageless")},100)}}}})(jQuery);
